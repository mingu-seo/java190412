<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="adopt">
    
    <typeAlias alias="vo" type="manage.adopt.AdoptVO"/>
    <typeAlias alias="param" type="manage.adopt.AdoptVO"/>
    
    <!-- 공통조건 -->
	<sql id="searchSql">		
		<!-- WHERE 절 검색 -->
		<dynamic prepend="where">
		    1=1
			<isNotEqual property="sval" compareValue="" prepend="and">
				<isEqual property="stype" compareValue="all" prepend="and">
					( (name like '%$sval$%' ) or (id like '%$sval$%' ) or (memo like '%$sval$%') ) 					
				</isEqual>
				<isNotEqual property="stype" compareValue="all" prepend="and">
					($stype$ like '%$sval$%' )
				</isNotEqual>
			</isNotEqual>
		</dynamic>
	</sql>
	
	<select id="count" parameterClass="param" resultClass="Integer">
        select count(*) from animal_pro
        <include refid="searchSql" />	
    </select>
	
    <select id="list" parameterClass="param" resultClass="vo">
        select * from animal_pro
        <include refid="searchSql" />
		ORDER BY no DESC LIMIT $startPageNo$, $pageRows$	
    </select>
    
    <insert id="insert" parameterClass="vo" >
        insert into animal_pro
        	(animal_category, animal_image, animal_image_org, name, gender, age, charr, breed, vac, state, registdate)
        values
        	(#animal_category#, #animal_image#, #animal_image_org#, #name#, #gender#, #age#, #charr#, #breed#, #vac#, #state#, now())
        <selectKey keyProperty="no" resultClass="Integer">
			SELECT  LAST_INSERT_ID()
		</selectKey>
    </insert>
    
    <update id="update" parameterClass="vo">
        update animal_pro set
        	<isNotEqual property="password" compareValue="">
        	    password = md5(#password#),
        	</isNotEqual>
        	animal_category=#animal_category#, animal_image=#animal_image#, animal_image_org=#animal_image_org#, name=#name#, gender=#gender#, age=#age#, charr=#charr#, breed=#breed#, 
        	vac=#vac#, state=#state#
        where no=#no#
    </update>
    
    <delete id="delete" parameterClass="Integer">
        delete from adopt where no=#no#
    </delete>
    
    <select id="read" parameterClass="Integer" resultClass="vo">
    	<![CDATA[
        select no, id, password, email,
        	name, memo, registdate,
        	ifnull((select max(no) from adopt where no>1 and no<#no#), 0) as prev_no,
        	ifnull((select min(no) from adopt where no>1 and no>#no#), 0) as next_no
         from adopt where no>1 and no=#no#
         ]]>
    </select>
    
    <select id="idcheck" parameterClass="param" resultClass="Integer">
        select count(*) as cnt from adopt where id=#id#
    </select>
    
    <select id="loginCheck" parameterClass="param" resultClass="Integer">
        select count(*) as cnt from adopt where id=#id# and password=md5(#password#)
    </select>
    
    <select id="loginSessionInfo" parameterClass="param" resultClass="vo">
        select * from adopt where id=#id# and password=md5(#password#)
    </select>
    
</sqlMap>